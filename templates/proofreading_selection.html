{% extends "base.html" %}

{% block title %}Proofreading - Layer Selection{% endblock %}
{% block page_title %}Proofreading - Layer Selection{% endblock %}

{% block content %}
<div class="proofreading-selection-container">
  {% if warning %}
    <div class="alert alert-warning">
      <h3>‚ö†Ô∏è Warning</h3>
      <p>{{ warning }}</p>
    </div>
  {% endif %}

  {% if not warning %}
  <div class="selection-header">
    <h2>Select Incorrect Layers for Proofreading</h2>
    <p>Choose which incorrect layers you want to proofread and correct.</p>
  </div>

  <div class="selection-stats">
    <div class="stats-grid">
      <div class="stat-card correct">
        <div class="stat-number">{{ progress.correct }}</div>
        <div class="stat-label">Correct</div>
      </div>
      <div class="stat-card incorrect">
        <div class="stat-number">{{ progress.incorrect }}</div>
        <div class="stat-label">Incorrect</div>
      </div>
      <div class="stat-card unsure">
        <div class="stat-number">{{ progress.unsure }}</div>
        <div class="stat-label">Unsure</div>
      </div>
      <div class="stat-card total">
        <div class="stat-number">{{ progress.total }}</div>
        <div class="stat-label">Total Layers</div>
      </div>
    </div>
  </div>

  <div class="layer-selection">
    <div class="selection-controls">
      <div class="control-group">
        <button class="btn btn-primary" id="select-all">Select All</button>
        <button class="btn btn-secondary" id="select-none">Select None</button>
      </div>
      <div class="control-group">
        <span class="selection-count">0 layers selected</span>
      </div>
    </div>
    
    <div class="start-proofreading-section">
      <button class="btn btn-success btn-large" id="start-proofreading" disabled>
        <span class="btn-icon">üîß</span>
        Start Proofreading
        <span class="btn-subtitle">Begin correcting selected layers</span>
      </button>
    </div>

    <div class="layer-grid">
      {% for layer in incorrect_layers %}
      <div class="layer-card" data-layer-id="{{ layer.id }}">
        <div class="layer-preview">
          <div class="layer-thumbnail">
            <span class="layer-number">{{ layer.slice_index + 1 if layer.slice_index is defined else loop.index }}</span>
          </div>
        </div>
        <div class="layer-info">
          <div class="layer-name">Layer {{ layer.slice_index + 1 if layer.slice_index is defined else loop.index }}</div>
          <div class="layer-status incorrect">Incorrect</div>
        </div>
        <div class="layer-actions">
          <label class="checkbox-label">
            <input type="checkbox" class="layer-checkbox" data-layer-id="{{ layer.id }}">
            <span class="checkmark"></span>
          </label>
          <button class="btn btn-primary btn-sm proofread-single" data-layer-id="{{ layer.id }}">
            Proofread
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="selection-actions">
    <div class="action-buttons">
      <button class="btn btn-secondary" id="back-to-detection">Back to Detection</button>
      <button class="btn btn-primary" id="view-all-layers">View All Layers</button>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.proofreading-selection-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.selection-header {
  text-align: center;
  margin-bottom: 2rem;
}

.selection-header h2 {
  color: #374151;
  margin-bottom: 0.5rem;
}

.selection-header p {
  color: #6b7280;
  font-size: 1.1rem;
}

.selection-stats {
  margin-bottom: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.stat-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.stat-card.correct {
  border-color: #10b981;
  background: #f0fdf4;
}

.stat-card.incorrect {
  border-color: #dc2626;
  background: #fef2f2;
}

.stat-card.unsure {
  border-color: #f59e0b;
  background: #fef3c7;
}

.stat-card.total {
  border-color: #3b82f6;
  background: #eff6ff;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #374151;
  margin-bottom: 0.5rem;
}

.stat-card.correct .stat-number {
  color: #10b981;
}

.stat-card.incorrect .stat-number {
  color: #dc2626;
}

.stat-card.unsure .stat-number {
  color: #f59e0b;
}

.stat-card.total .stat-number {
  color: #3b82f6;
}

.stat-label {
  color: #6b7280;
  font-size: 0.875rem;
  font-weight: 500;
}

.layer-selection {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  margin-bottom: 2rem;
}

.selection-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e5e7eb;
}

.start-proofreading-section {
  text-align: center;
  margin: 2rem 0;
}

.btn-large {
  font-size: 1.125rem;
  padding: 1rem 2rem;
  border-radius: 0.5rem;
  font-weight: 600;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  min-width: 200px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
}

.btn-large:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-large:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-icon {
  font-size: 1.5rem;
  margin-bottom: 0.25rem;
}

.btn-subtitle {
  font-size: 0.875rem;
  font-weight: 400;
  opacity: 0.8;
}

.control-group {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.selection-count {
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 500;
}

.layer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}

.layer-card {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  transition: all 0.2s;
}

.layer-card:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
}

.layer-card.selected {
  background: #eff6ff;
  border-color: #3b82f6;
}

.layer-preview {
  margin-right: 1rem;
}

.layer-thumbnail {
  width: 60px;
  height: 60px;
  background: #e5e7eb;
  border-radius: 0.375rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #d1d5db;
}

.layer-number {
  font-size: 1.25rem;
  font-weight: bold;
  color: #374151;
}

.layer-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.layer-name {
  font-weight: 500;
  color: #374151;
  font-size: 1rem;
}

.layer-status {
  font-size: 0.875rem;
  font-weight: 500;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  display: inline-block;
  width: fit-content;
}

.layer-status.incorrect {
  background: #fef2f2;
  color: #dc2626;
}

.layer-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: center;
}

.checkbox-label {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 0.875rem;
  color: #374151;
}

.checkbox-label input[type="checkbox"] {
  margin-right: 0.5rem;
}

.proofread-single {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
}

.selection-actions {
  text-align: center;
  padding: 2rem;
  background: #f9fafb;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.alert {
  padding: 1rem;
  border-radius: 0.5rem;
  margin-bottom: 2rem;
}

.alert-warning {
  background: #fef3c7;
  border: 1px solid #f59e0b;
  color: #92400e;
}

.alert h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1.125rem;
}

.alert p {
  margin: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class ProofreadingSelection {
  constructor() {
    this.selectedLayers = new Set();
    this.setupEventListeners();
  }

  setupEventListeners() {
    // Checkbox selection
    document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const layerId = e.target.dataset.layerId;
        if (e.target.checked) {
          this.selectedLayers.add(layerId);
          e.target.closest('.layer-card').classList.add('selected');
        } else {
          this.selectedLayers.delete(layerId);
          e.target.closest('.layer-card').classList.remove('selected');
        }
        this.updateSelectionCount();
        this.updateStartButton();
      });
    });

    // Single layer proofreading
    document.querySelectorAll('.proofread-single').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const layerId = e.target.dataset.layerId;
        this.startProofreading([layerId]);
      });
    });

    // Selection controls
    document.getElementById('select-all')?.addEventListener('click', () => {
      this.selectAll();
    });

    document.getElementById('select-none')?.addEventListener('click', () => {
      this.selectNone();
    });

    document.getElementById('start-proofreading')?.addEventListener('click', () => {
      this.startProofreading(Array.from(this.selectedLayers));
    });

    // Navigation
    document.getElementById('back-to-detection')?.addEventListener('click', () => {
      window.location.href = '/detection';
    });

    document.getElementById('view-all-layers')?.addEventListener('click', () => {
      window.location.href = '/review';
    });
  }

  selectAll() {
    document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
      checkbox.checked = true;
      this.selectedLayers.add(checkbox.dataset.layerId);
      checkbox.closest('.layer-card').classList.add('selected');
    });
    this.updateSelectionCount();
    this.updateStartButton();
  }

  selectNone() {
    document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
      checkbox.checked = false;
      this.selectedLayers.delete(checkbox.dataset.layerId);
      checkbox.closest('.layer-card').classList.remove('selected');
    });
    this.updateSelectionCount();
    this.updateStartButton();
  }

  updateSelectionCount() {
    const count = this.selectedLayers.size;
    const countElement = document.querySelector('.selection-count');
    if (countElement) {
      countElement.textContent = `${count} layer${count !== 1 ? 's' : ''} selected`;
    }
  }

  updateStartButton() {
    const startBtn = document.getElementById('start-proofreading');
    if (startBtn) {
      startBtn.disabled = this.selectedLayers.size === 0;
    }
  }

  startProofreading(layerIds) {
    if (layerIds.length === 0) {
      alert('Please select at least one layer to proofread.');
      return;
    }

    // Start with the first selected layer
    const firstLayerId = layerIds[0];
    window.location.href = `/proofreading/edit/${firstLayerId}`;
  }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  new ProofreadingSelection();
});
</script>
{% endblock %}
